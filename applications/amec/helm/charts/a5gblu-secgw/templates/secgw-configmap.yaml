# SPDX-License-Identifier: Apache-2.0
# Copyright (c) 2022 A5G Networks Inc.
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "a5gblu.configmapPrefix" $ }}-egress-cfg
  namespace: {{ .Release.Namespace }}
  labels:
    epc-mode: secgw
data:
  settings.sh: |
    #!/bin/sh
    # Generated by cfgmap
    EGRESS_NW_SUBNET="{{ .Values.vippool }}"
    EGRESS_NW_GW="{{ include "a5gblu.secgwegsvc" $ }}"
    EGRESS_NW_GW_FORWARD="yes"

---

apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "a5gblu.configmapPrefix" $ }}-server-cfg
  namespace: {{ .Release.Namespace }}
  labels:
    epc-mode: secgw
data:
  ipsec.conf: |
    # ipsec.conf - strongSwan IPsec configuration file
    # basic configuration
    config setup
            charondebug="ike 4, knl 2, cfg 4, net 2, esp 2, dmn 2, mgr 2"
            strictcrlpolicy=no
            uniqueids=yes
            cachecrls=no
    
    conn ipsec-ikev2-vpn
          auto=add
          compress=no
          type=tunnel  # defines the type of connection, tunnel.
          keyexchange=ikev2
          ike=aes128-sha1-modp1024! 
          esp=aes128-sha1
          fragmentation=no
          forceencaps=yes
          dpdaction=clear
          dpddelay=300s
          rekey=no
          left=%any
          leftid=iotnode.parallelwireless.com    # if using IP, define it without the @ sign
          leftcert=/etc/ipsec.d/certs/server_cert.crt  # reads the VPN server cert in /etc/ipsec.d/certs
          leftsendcert=always
          leftsubnet={{ .Values.serverSubnet }}
          leftauth=pubkey
          right=%any
          rightid=%any
          rightauth=pubkey
          rightsubnet=%dynamic
          rightsourceip={{ .Values.vippool }}
    
    conn ipsec-ikev2-vpn-sim
          auto=add
          compress=no
          type=tunnel  # defines the type of connection, tunnel.
          keyexchange=ikev2
          ike=aes128-sha1-modp1024!
          esp=aes128-sha1
          fragmentation=no
          forceencaps=yes
          dpdaction=clear
          dpddelay=300s
          rekey=no
          left=%any
          leftid=@sim-server.a5gnet.com    # if using IP, define it without the @ sign
          leftcert=/etc/ipsec.d/certs/simServerCert.pem  # reads the VPN server cert in /etc/ipsec.d/certs
          leftsendcert=always
          leftsubnet={{ .Values.serverSubnet }}
          leftauth=pubkey
          right=%any
          rightid=%any
          rightauth=pubkey
          rightsubnet=%dynamic
          rightsourceip={{ .Values.vippool }}

